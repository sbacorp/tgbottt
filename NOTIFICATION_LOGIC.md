# üîî –õ–æ–≥–∏–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≤ CBR Monitoring Bot

–ü–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞ Supabase –±—ã–ª–∞ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ **—É–º–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π**, –∫–æ—Ç–æ—Ä–∞—è –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ —Ç–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º, –∫–æ—Ç–æ—Ä—ã–µ —Ä–µ–∞–ª—å–Ω–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—é—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é.

## üèóÔ∏è –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö

### –ì—Ä—É–ø–ø—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
```sql
user_groups:
  - id (PK)
  - name (–Ω–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã)
  - owner_id (–≤–ª–∞–¥–µ–ª–µ—Ü –≥—Ä—É–ø–ø—ã)
  - invite_code (–∫–æ–¥ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è)
  - created_at

group_members:
  - group_id (FK)
  - user_id (FK)
  - joined_at

group_organizations:
  - group_id (FK)
  - inn (FK)
  - added_by (–∫—Ç–æ –¥–æ–±–∞–≤–∏–ª)
  - added_at
```

### –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ
```sql
user_organizations:
  - user_id (FK)
  - inn (FK)
```

## üß† –ü—Ä–æ—Å—Ç–∞—è –≥—Ä—É–ø–ø–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

### sendOrganizationNotification(inn, message)

**–¢–æ–ª—å–∫–æ –≥—Ä—É–ø–ø–æ–≤—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:**
1. –ò—â–µ–º –≥—Ä—É–ø–ø—ã, –∫–æ—Ç–æ—Ä—ã–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—é—Ç –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é —á–µ—Ä–µ–∑ `getGroupsByOrganization(inn)`
2. –ï—Å–ª–∏ –≥—Ä—É–ø–ø—ã –Ω–∞–π–¥–µ–Ω—ã:
   - –ü–æ–ª—É—á–∞–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –∫–∞–∂–¥–æ–π –≥—Ä—É–ø–ø—ã
   - –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (–±–µ–∑ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è)
   - –õ–æ–≥–∏—Ä—É–µ–º: "—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ X –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –≤ Y –≥—Ä—É–ø–ø–∞—Ö"

**–ï—Å–ª–∏ –≥—Ä—É–ø–ø –Ω–µ—Ç:**
3. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∞–º —Å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ–º
4. –õ–æ–≥–∏—Ä—É–µ–º: "–Ω–∏ –æ–¥–Ω–∞ –≥—Ä—É–ø–ø–∞ –Ω–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é"

> **–í–∞–∂–Ω–æ:** –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ `user_organizations` –æ—Ç–∫–ª—é—á–µ–Ω–æ. –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –≥—Ä—É–ø–ø—ã!

## üìä –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –Ω–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã

‚úÖ **–¢–æ—á–µ—á–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è** - —Ç–æ–ª—å–∫–æ –∑–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–Ω–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º  
‚úÖ **–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≥—Ä—É–ø–ø** - –∫–æ–º–∞–Ω–¥–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Å –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è–º–∏  
‚úÖ **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Å–ø–∞–º–∞** - –Ω–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≤—Å–µ–º –ø–æ–¥—Ä—è–¥  
‚úÖ **Fallback –ª–æ–≥–∏–∫–∞** - —Å–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö  
‚úÖ **–î–µ—Ç–∞–ª—å–Ω—ã–µ –ª–æ–≥–∏** - –ø–æ–Ω—è—Ç–Ω–æ –∫–æ–º—É –∏ —Å–∫–æ–ª—å–∫–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ  

## üîÑ –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –ø—Ä–∞–∫—Ç–∏–∫–µ

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –ì—Ä—É–ø–ø–∞ "–§–∏–Ω—Ç–µ—Ö –∫–æ–º–ø–∞–Ω–∏–∏"
```
–ì—Ä—É–ø–ø–∞: "–§–∏–Ω—Ç–µ—Ö –∫–æ–º–ø–∞–Ω–∏–∏" (3 —É—á–∞—Å—Ç–Ω–∏–∫–∞)
–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏: –ò–ù–ù 1234567890, –ò–ù–ù 9876543210

–°—Ç–∞—Ç—É—Å –ò–ù–ù 1234567890 –∏–∑–º–µ–Ω–∏–ª—Å—è ‚Üí 
–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—É—á–∞—é—Ç —Ç–æ–ª—å–∫–æ 3 —É—á–∞—Å—Ç–Ω–∏–∫–∞ –≥—Ä—É–ø–ø—ã
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –ù–∏–∫—Ç–æ –Ω–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç
```
–ò–ù–ù 9999999999 –∏–∑–º–µ–Ω–∏–ª —Å—Ç–∞—Ç—É—Å, –Ω–æ –Ω–∏–∫—Ç–æ –µ–≥–æ –Ω–µ –¥–æ–±–∞–≤–∏–ª ‚Üí
–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—É—á–∞—é—Ç —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω—ã —Å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ–º
```

## üöÄ –ú–µ—Ç–æ–¥—ã API

### –û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
```typescript
// –£–º–Ω—ã–π –º–µ—Ç–æ–¥ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
await notificationService.sendOrganizationNotification(inn, message);

// –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≥—Ä—É–ø–ø–∞–º –ø–æ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏
await notificationService.sendNotificationToGroupsByOrganization(inn, message);

// Legacy –º–µ—Ç–æ–¥ (–≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º)
await notificationService.sendNotificationToAllUsers(message);

// –¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∞–º
await notificationService.sendAdminNotification(message);
```

### –ú–µ—Ç–æ–¥—ã —Ä–∞–±–æ—Ç—ã —Å –≥—Ä—É–ø–ø–∞–º–∏
```typescript
// –°–æ–∑–¥–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã
const group = await database.createUserGroup("–ú–æ—è –≥—Ä—É–ø–ø–∞", ownerId);

// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –≤ –≥—Ä—É–ø–ø—É
await database.addGroupOrganization(groupId, inn, addedBy);

// –ü–æ–ª—É—á–µ–Ω–∏–µ –≥—Ä—É–ø–ø –ø–æ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏
const groups = await database.getGroupsByOrganization(inn);

// –ü–æ–ª—É—á–µ–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –≥—Ä—É–ø–ø—ã
const members = await database.getGroupMembers(groupId);
```

## ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞

### –°–æ–∑–¥–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–µ—Ç –≥—Ä—É–ø–ø—É —á–µ—Ä–µ–∑ –±–æ—Ç–∞
2. –ü–æ–ª—É—á–∞–µ—Ç –∫–æ–¥ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è
3. –î–µ–ª–∏—Ç—Å—è –∫–æ–¥–æ–º —Å –∫–æ–ª–ª–µ–≥–∞–º–∏
4. –î–æ–±–∞–≤–ª—è–µ—Ç –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è

### –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∫ –≥—Ä—É–ø–ø–µ
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç –∫–æ–¥ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è
2. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è —É—á–∞—Å—Ç–Ω–∏–∫–æ–º
3. –ü–æ–ª—É—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ –≤—Å–µ–º –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è–º –≥—Ä—É–ø–ø—ã

## üîß –ú–∏–≥—Ä–∞—Ü–∏—è —Å —Å—Ç–∞—Ä–æ–π —Å–∏—Å—Ç–µ–º—ã

**–ë—ã–ª–æ (–¥–æ –º–∏–≥—Ä–∞—Ü–∏–∏):**
- –í—Å–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª—è–ª–∏—Å—å –≤—Å–µ–º –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
- –ú–Ω–æ–≥–æ —Å–ø–∞–º–∞ –¥–ª—è –Ω–µ–∑–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –ù–µ—Ç –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ –ø–æ –∏–Ω—Ç–µ—Ä–µ—Å–∞–º

**–°—Ç–∞–ª–æ (–ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏):**
- –£–º–Ω–∞—è –ª–æ–≥–∏–∫–∞ —Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º–∏
- –ì—Ä—É–ø–ø–æ–≤–æ–µ –∏ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ
- –¢–æ—á–µ—á–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- Fallback –Ω–∞ –∞–¥–º–∏–Ω–æ–≤

## üìù –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–°–∏—Å—Ç–µ–º–∞ –ø–æ–¥—Ä–æ–±–Ω–æ –ª–æ–≥–∏—Ä—É–µ—Ç –≤—Å–µ –¥–µ–π—Å—Ç–≤–∏—è:

```
[INFO] Organization notification for 1234567890 sent to 5 unique users across 2 groups
[INFO] Notification sent to 3 members of group "–§–∏–Ω—Ç–µ—Ö" for organization 1234567890  
[WARN] No users or groups tracking organization 9999999999, sending to admins only
[ERROR] Error in smart organization notification for 1234567890: fallback to admins
```

---

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–æ–ª—É—á–∞—é—Ç —Ç–æ–ª—å–∫–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è–º, –∫–æ—Ç–æ—Ä—ã–µ –æ–Ω–∏ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—é—Ç! üéØ
